@startuml Microservices Architecture with Kafka, Redis, MongoDB

title Microservices Architecture - Complete System

package "Client Layer" {
  [Web Client] as Client
  [Mobile App] as Mobile
  [Postman] as Postman
}

package "API Gateway" {
  [API Gateway :8080] as Gateway
}

package "Microservices" {
  package "Auth Service :3001" {
    [Auth Controller] as AuthCtrl
    [Auth Service] as AuthSvc
    [Auth Repository] as AuthRepo
  }

  package "User Service :3002" {
    [User Controller] as UserCtrl
    [User Service] as UserSvc
    [User Repository] as UserRepo
    [Cache Service] as CacheSvc
  }

  package "Order Service :3003" {
    [Order Controller] as OrderCtrl
    [Order Service] as OrderSvc
    [Order Repository] as OrderRepo
  }

  package "Payment Service :3004" {
    [Payment Controller] as PaymentCtrl
    [Payment Service] as PaymentSvc
    [Payment Repository] as PaymentRepo
    [Gateway Service] as GatewaySvc
    [Kafka Producer] as KafkaProd
  }

  package "Notification Service :3005" {
    [Notification Controller] as NotifCtrl
    [Notification Service] as NotifSvc
    [Notification Repository] as NotifRepo
    [Kafka Consumer] as KafkaCons
  }
}

package "Message Broker" {
  [Kafka :9092] as Kafka
  [Zookeeper] as Zookeeper
}

package "Cache Layer" {
  [Redis :6379] as Redis
}

package "Databases" {
  database "PostgreSQL :5432" as PostgreSQL {
    [auth_users] as AuthTable
    [users] as UserTable
    [orders] as OrderTable
    [payments] as PaymentTable
  }

  database "MongoDB :27017" as MongoDB {
    [notifications] as NotifCollection
  }
}

' Client connections
Client --> Gateway
Mobile --> Gateway
Postman --> Gateway

' Gateway routing
Gateway --> AuthCtrl : "/api/register, /api/login"
Gateway --> UserCtrl : "/api/users/*"
Gateway --> OrderCtrl : "/api/orders/*"
Gateway --> PaymentCtrl : "/api/payments/*"
Gateway --> NotifCtrl : "/api/notifications/*"

' Internal Gateway routing
Gateway --> UserCtrl : "/internal/users/*"
Gateway --> OrderCtrl : "/internal/orders/*"

' Payment Service internal calls
PaymentSvc --> GatewaySvc
GatewaySvc --> Gateway

' Kafka event flow
PaymentSvc --> KafkaProd
KafkaProd --> Kafka : "Publish events"
Kafka --> KafkaCons : "Consume events"
KafkaCons --> NotifSvc

' Redis caching
UserSvc --> CacheSvc
CacheSvc --> Redis : "Cache operations"

' Service layer connections
AuthCtrl --> AuthSvc
AuthSvc --> AuthRepo

UserCtrl --> UserSvc
UserSvc --> UserRepo
UserSvc --> CacheSvc

OrderCtrl --> OrderSvc
OrderSvc --> OrderRepo

PaymentCtrl --> PaymentSvc
PaymentSvc --> PaymentRepo

NotifCtrl --> NotifSvc
NotifSvc --> NotifRepo

' Database connections
AuthRepo --> AuthTable
UserRepo --> UserTable
OrderRepo --> OrderTable
PaymentRepo --> PaymentTable
NotifRepo --> NotifCollection

' Kafka infrastructure
Kafka --> Zookeeper

' Notes
note right of KafkaProd : "Publishes payment events\nto payment-events topic"
note right of KafkaCons : "Consumes payment events\nand creates notifications"
note right of CacheSvc : "Cache-aside pattern\nTTL: 1 hour"
note right of NotifRepo : "MongoDB - Database per Service\nIndependent schema"

@enduml
