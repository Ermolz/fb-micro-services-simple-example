name: Test Microservices Build and Health

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          echo "Installing Docker Compose..."
          DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version || {
            echo "‚ùå Docker Compose installation failed"
            exit 1
          }
          echo "‚úÖ Docker Compose installed successfully"

      - name: Create .env files for services
        run: |
          # Create env files for each service if they don't exist
          mkdir -p auth-service user-service order-service payment-service notification-service api-gateway
          
          # Auth Service
          cat > auth-service/env << EOF
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=microservices_db
          DB_USER=postgres
          DB_PASSWORD=password
          JWT_SECRET=test-jwt-secret-key-for-ci
          JWT_EXPIRES_IN=24h
          AUTH_SERVICE_PORT=3001
          EOF
          
          # User Service
          cat > user-service/env << EOF
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=microservices_db
          DB_USER=postgres
          DB_PASSWORD=password
          JWT_SECRET=test-jwt-secret-key-for-ci
          REDIS_URL=redis://redis:6379
          USER_SERVICE_PORT=3002
          EOF
          
          # Order Service
          cat > order-service/env << EOF
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=microservices_db
          DB_USER=postgres
          DB_PASSWORD=password
          JWT_SECRET=test-jwt-secret-key-for-ci
          ORDER_SERVICE_PORT=3003
          EOF
          
          # Payment Service
          cat > payment-service/env << EOF
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=microservices_db
          DB_USER=postgres
          DB_PASSWORD=password
          GATEWAY_URL=http://api-gateway:8080
          KAFKA_BROKER=kafka:9092
          PAYMENT_SERVICE_PORT=3004
          EOF
          
          # Notification Service
          cat > notification-service/env << EOF
          MONGODB_URL=mongodb://mongodb:27017
          MONGODB_DB=notifications_db
          KAFKA_BROKER=kafka:9092
          NOTIFICATION_SERVICE_PORT=3005
          EOF
          
          # API Gateway
          cat > api-gateway/env << EOF
          GATEWAY_PORT=8080
          AUTH_SERVICE_URL=http://auth-service:3001
          USER_SERVICE_URL=http://user-service:3002
          ORDER_SERVICE_URL=http://order-service:3003
          PAYMENT_SERVICE_URL=http://payment-service:3004
          NOTIFICATION_SERVICE_URL=http://notification-service:3005
          EOF

      - name: Verify docker-compose.yml exists
        run: |
          if [ ! -f "docker-compose.yml" ]; then
            echo "‚ùå docker-compose.yml not found!"
            exit 1
          fi
          echo "‚úÖ docker-compose.yml found"

      - name: Build Docker images
        run: |
          echo "üî® Building Docker images..."
          docker-compose build --no-cache 2>&1 | tee build.log || {
            echo "‚ùå Build failed. Checking logs..."
            cat build.log | tail -50
            exit 1
          }
        continue-on-error: true

      - name: Start services
        run: |
          echo "üöÄ Starting services..."
          docker-compose up -d 2>&1 | tee start.log
          
          echo "‚è≥ Waiting for services to start..."
          sleep 60
          
          echo "üìä Service status:"
          docker-compose ps

      - name: Check service health
        id: health_check
        run: |
          echo "üè• Checking service health..."
          
          REPORT_FILE="service-report.md"
          echo "# Service Health Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Build Date:** $(date)" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          OVERALL_STATUS="SUCCESS"
          FAILED_COUNT=0
          
          check_container() {
            SERVICE_NAME=$1
            CONTAINER_NAME=$2
            
            echo "Checking $SERVICE_NAME..."
            if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "unknown")
              if [ "$CONTAINER_STATUS" = "running" ]; then
                echo "‚úÖ $SERVICE_NAME is running" | tee -a $REPORT_FILE
                return 0
              else
                echo "‚ùå $SERVICE_NAME is not running (status: $CONTAINER_STATUS)" | tee -a $REPORT_FILE
                FAILED_COUNT=$((FAILED_COUNT + 1))
                return 1
              fi
            else
              echo "‚ùå $SERVICE_NAME container not found" | tee -a $REPORT_FILE
              FAILED_COUNT=$((FAILED_COUNT + 1))
              return 1
            fi
          }
          
          check_http_service() {
            SERVICE_NAME=$1
            PORT=$2
            ENDPOINT=${3:-/health}
            METHOD=${4:-GET}
            MAX_RETRIES=5
            RETRY=0
            
            echo "Checking $SERVICE_NAME on port $PORT..."
            while [ $RETRY -lt $MAX_RETRIES ]; do
              if [ "$METHOD" = "POST" ]; then
                RESPONSE=$(curl -s -m 5 -X POST "http://localhost:$PORT$ENDPOINT" -H "Content-Type: application/json" -d '{}' 2>&1)
                if echo "$RESPONSE" | grep -q "error\|required" || [ ${#RESPONSE} -gt 0 ]; then
                  echo "‚úÖ $SERVICE_NAME is responding" | tee -a $REPORT_FILE
                  return 0
                fi
              else
                if curl -f -s -m 5 "http://localhost:$PORT$ENDPOINT" > /dev/null 2>&1; then
                  echo "‚úÖ $SERVICE_NAME is healthy" | tee -a $REPORT_FILE
                  return 0
                fi
              fi
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                sleep 2
              fi
            done
            
            echo "‚ùå $SERVICE_NAME is not responding after $MAX_RETRIES attempts" | tee -a $REPORT_FILE
            FAILED_COUNT=$((FAILED_COUNT + 1))
            return 1
          }
          
          echo "## Infrastructure Services" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          check_container "PostgreSQL" "postgres" || true
          check_container "Redis" "redis" || true
          check_container "MongoDB" "mongodb" || true
          check_container "Zookeeper" "zookeeper" || true
          check_container "Kafka" "kafka" || true
          
          echo "" >> $REPORT_FILE
          echo "## Microservices" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          check_http_service "Auth Service" 3001 "/api/register" "POST" || true
          check_http_service "User Service" 3002 "/health" || true
          check_http_service "Order Service" 3003 "/health" || true
          check_http_service "Payment Service" 3004 "/health" || true
          check_http_service "Notification Service" 3005 "/health" || true
          check_http_service "API Gateway" 8080 "/health" || true
          
          echo "" >> $REPORT_FILE
          echo "## Overall Status" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          if [ $FAILED_COUNT -gt 0 ]; then
            OVERALL_STATUS="FAILED"
            echo "‚ùå FAILED - $FAILED_COUNT service(s) failed" >> $REPORT_FILE
          else
            echo "‚úÖ SUCCESS - All services are healthy" >> $REPORT_FILE
          fi
          
          echo "status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          
          cat $REPORT_FILE

      - name: Get service logs
        if: failure()
        run: |
          echo "üìã Collecting service logs..."
          mkdir -p logs
          
          docker-compose ps > logs/services-status.txt
          docker-compose logs postgres > logs/postgres.log 2>&1 || true
          docker-compose logs redis > logs/redis.log 2>&1 || true
          docker-compose logs mongodb > logs/mongodb.log 2>&1 || true
          docker-compose logs zookeeper > logs/zookeeper.log 2>&1 || true
          docker-compose logs kafka > logs/kafka.log 2>&1 || true
          docker-compose logs auth-service > logs/auth-service.log 2>&1 || true
          docker-compose logs user-service > logs/user-service.log 2>&1 || true
          docker-compose logs order-service > logs/order-service.log 2>&1 || true
          docker-compose logs payment-service > logs/payment-service.log 2>&1 || true
          docker-compose logs notification-service > logs/notification-service.log 2>&1 || true
          docker-compose logs api-gateway > logs/api-gateway.log 2>&1 || true

      - name: Create error report
        if: failure()
        run: |
          echo "üìù Creating error report..."
          
          ERROR_REPORT="error-report.md"
          echo "# Error Report" > $ERROR_REPORT
          echo "" >> $ERROR_REPORT
          echo "**Build Date:** $(date)" >> $ERROR_REPORT
          echo "" >> $ERROR_REPORT
          
          # Check each service for errors
          echo "## Failed Services" >> $ERROR_REPORT
          echo "" >> $ERROR_REPORT
          
          for service in postgres redis mongodb zookeeper kafka auth-service user-service order-service payment-service notification-service api-gateway; do
            if [ -f "logs/${service}.log" ]; then
              ERROR_COUNT=$(grep -i "error\|failed\|exception" logs/${service}.log | wc -l || echo "0")
              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo "### $service" >> $ERROR_REPORT
                echo "" >> $ERROR_REPORT
                echo "**Error Count:** $ERROR_COUNT" >> $ERROR_REPORT
                echo "" >> $ERROR_REPORT
                echo "**Last 20 error lines:**" >> $ERROR_REPORT
                echo '```' >> $ERROR_REPORT
                grep -i "error\|failed\|exception" logs/${service}.log | tail -20 >> $ERROR_REPORT || true
                echo '```' >> $ERROR_REPORT
                echo "" >> $ERROR_REPORT
              fi
            fi
          done
          
          # Show service status
          echo "## Service Status" >> $ERROR_REPORT
          echo "" >> $ERROR_REPORT
          echo '```' >> $ERROR_REPORT
          docker-compose ps >> $ERROR_REPORT || true
          echo '```' >> $ERROR_REPORT
          
          cat $ERROR_REPORT

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: |
            logs/
            build.log
            start.log
            service-report.md
            error-report.md
          retention-days: 7

      - name: Comment PR with report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## üîç Service Health Check Report\n\n';
            
            if (fs.existsSync('service-report.md')) {
              report += fs.readFileSync('service-report.md', 'utf8');
            }
            
            if (fs.existsSync('error-report.md')) {
              report += '\n\n' + fs.readFileSync('error-report.md', 'utf8');
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if services are down
        run: |
          if [ "${{ steps.health_check.outputs.status }}" == "FAILED" ]; then
            echo "‚ùå Some services failed health checks. Failed count: ${{ steps.health_check.outputs.failed_count }}"
            echo "Check the logs and service-report.md for details."
            exit 1
          fi
          echo "‚úÖ All services are healthy!"

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          docker-compose down -v || true
